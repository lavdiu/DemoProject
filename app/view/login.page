<?php


use Laf\UI\Container\HtmlContainer;
use Laf\Util\UrlParser;
use Lavdiu\DemoApp\Factory;
use Lavdiu\DemoApp\Person;
use Lavdiu\DemoApp\RoutingTable;


if(UrlParser::getModule() == 'logout'){
    unset($_SESSION['uid']);
    unset($_SESSION['uname']);
    unset($_SESSION['emri']);
    unset($_SESSION['filialet']);
    unset($_SESSION['filialja']);
    unset($_SESSION['person']);
    session_destroy();
}
if (isset($_POST['login']) && isset($_POST['username']) && $_POST['username'] != '' && isset($_POST['password']) && $_POST['password'] != '') {
    $person = Person::login($_POST['username'], $_POST['password']);
    if ($person->recordExists()) {

        $_SESSION['person']['id'] = $person->getIdVal();
        $_SESSION['uid'] = $person->getIdVal();
        $_SESSION['uname'] = $person->getEmailVal();
        setcookie('username', $person->getEmailVal(), (time() + 24 * 3600 * 7));
        RoutingTable::buildAndCacheMenu();
        header('location:?');
        exit;

    }
}


$html = "
<div class='container'>
	<div class='row'>
		<div class='col-md-12 min-vh-100 d-flex flex-column justify-content-center'>
			<div class='row'>
				<div class='col-lg-6 col-md-8 mx-auto'>
					<form class='form' role='form' autocomplete='off' id='login_form' method='POST' action='?mod=" . UrlParser::getModule() . "'>
						<div class='card rounded shadow shadow-sm'>
							<div class='card-header'>
								<h3 class='mb-0'>Demo APP</h3>
							</div>
								<div class='card-body'>
									<div class='form-group'>
										<label for='username'>Username</label>
										<input type='text' class='form-control form-control-lg rounded-0' name='username' id='username' required='required' value='" . (isset($_COOKIE['username']) ? $_COOKIE['username'] : "") . "' />
									</div>
									<div class='form-group'>
										<label for='password'>Password</label>
										<input type='password' class='form-control form-control-lg rounded-0' id='password' name='password' required='required' autocomplete='off' autofocus='autofocus'>
									</div>
								</div>
								<input type='submit' class='btn btn-outline-info btn-lg float-right' id='login' name='login' value='Login'>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>
</div>
";


$p = Factory::noMenuPage();
$p->addComponent(new HtmlContainer($html));
echo $p->draw();